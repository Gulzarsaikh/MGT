<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dispatch Tracker ‚Äî MGT International</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #f0f2f5;
    --surface: #ffffff;
    --surface2: #f8f9fa;
    --border: #e2e5ea;
    --border2: #d0d5dd;
    --accent: #1a56db;
    --accent-hover: #1648c0;
    --accent-light: #eff4ff;
    --green: #0a7556;
    --green-bg: #ecfdf5;
    --green-border: #6ee7b7;
    --red: #c01048;
    --red-bg: #fff1f3;
    --red-border: #fda29b;
    --orange: #b54708;
    --orange-bg: #fffaeb;
    --orange-border: #fec84b;
    --text: #101828;
    --text2: #344054;
    --muted: #667085;
    --muted2: #98a2b3;
    --shadow: 0 1px 3px rgba(16,24,40,0.1), 0 1px 2px rgba(16,24,40,0.06);
    --shadow-md: 0 4px 8px rgba(16,24,40,0.08), 0 2px 4px rgba(16,24,40,0.05);
    --font: 'Inter', sans-serif;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body { font-family:var(--font); background:var(--bg); color:var(--text); min-height:100vh; }

  /* LOGIN */
  #loginPage {
    display:flex; align-items:center; justify-content:center;
    min-height:100vh;
    background:linear-gradient(135deg,#1a56db 0%,#0f3a9e 100%);
  }
  .login-box {
    background:var(--surface); border-radius:16px;
    padding:40px; width:380px;
    box-shadow:0 20px 60px rgba(0,0,0,0.2);
  }
  .login-logo { text-align:center; margin-bottom:28px; }
  .login-logo .icon {
    width:60px; height:60px; background:var(--accent);
    border-radius:14px; display:inline-flex;
    align-items:center; justify-content:center;
    font-size:28px; margin-bottom:12px;
  }
  .login-logo h2 { font-size:20px; font-weight:700; }
  .login-logo p { font-size:12px; color:var(--muted); margin-top:3px; }
  .login-field { margin-bottom:16px; }
  .login-field label { display:block; font-size:12px; font-weight:500; color:var(--text2); margin-bottom:5px; }
  .login-field input {
    width:100%; padding:10px 12px; border:1px solid var(--border2);
    border-radius:8px; font-family:var(--font); font-size:13px; outline:none;
    transition:border-color 0.15s, box-shadow 0.15s;
  }
  .login-field input:focus { border-color:var(--accent); box-shadow:0 0 0 3px rgba(26,86,219,0.1); }
  .login-btn {
    width:100%; padding:11px; background:var(--accent); color:#fff;
    border:none; border-radius:8px; font-family:var(--font);
    font-size:14px; font-weight:600; cursor:pointer; transition:all 0.15s; margin-top:4px;
  }
  .login-btn:hover { background:var(--accent-hover); }
  .login-error {
    background:var(--red-bg); border:1px solid var(--red-border);
    color:var(--red); padding:10px 14px; border-radius:8px;
    font-size:12px; margin-bottom:14px; display:none;
  }

  /* MAIN APP */
  #mainApp { display:none; padding:24px; }

  .header {
    display:flex; align-items:center; justify-content:space-between;
    margin-bottom:20px; background:var(--surface);
    padding:14px 24px; border-radius:10px;
    box-shadow:var(--shadow); border:1px solid var(--border);
  }
  .header-left { display:flex; align-items:center; gap:12px; }
  .header-icon {
    width:40px; height:40px; background:var(--accent);
    border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:18px;
  }
  .header-left h1 { font-size:18px; font-weight:700; }
  .header-left p { font-size:12px; color:var(--muted); margin-top:1px; }
  .header-right { display:flex; align-items:center; gap:10px; }

  .user-pill {
    display:flex; align-items:center; gap:8px;
    background:var(--surface2); border:1px solid var(--border);
    padding:6px 14px; border-radius:100px; font-size:12px; color:var(--text2);
  }
  .role-badge { padding:2px 8px; border-radius:100px; font-size:10px; font-weight:700; }
  .role-owner { background:#fef3c7; color:#92400e; }
  .role-hod { background:var(--accent-light); color:var(--accent); }
  .role-planthead { background:var(--green-bg); color:var(--green); }

  .live-badge {
    display:flex; align-items:center; gap:6px;
    background:var(--green-bg); border:1px solid var(--green-border);
    padding:5px 12px; border-radius:100px; font-size:11px; font-weight:600; color:var(--green);
  }
  .live-dot { width:6px; height:6px; background:#10b981; border-radius:50%; animation:pulse 1.8s ease-in-out infinite; }
  @keyframes pulse { 0%,100%{opacity:1;transform:scale(1);} 50%{opacity:0.4;transform:scale(0.7);} }

  .logout-btn {
    padding:6px 14px; background:var(--red-bg); color:var(--red);
    border:1px solid var(--red-border); border-radius:8px;
    font-family:var(--font); font-size:12px; font-weight:600; cursor:pointer;
  }
  .logout-btn:hover { background:#ffe4e6; }

  /* TABS */
  .tabs {
    display:flex; gap:4px; margin-bottom:20px;
    background:var(--surface); padding:6px; border-radius:10px;
    box-shadow:var(--shadow); border:1px solid var(--border); width:fit-content;
  }
  .tab-btn {
    padding:8px 20px; border-radius:7px; border:none;
    font-family:var(--font); font-size:13px; font-weight:500;
    cursor:pointer; color:var(--muted); background:transparent; transition:all 0.15s;
  }
  .tab-btn.active { background:var(--accent); color:#fff; font-weight:600; box-shadow:var(--shadow); }

  /* STATS */
  .stats { display:grid; grid-template-columns:repeat(4,1fr); gap:16px; margin-bottom:20px; }
  .stat-card {
    background:var(--surface); border:1px solid var(--border);
    border-radius:10px; padding:16px 20px; box-shadow:var(--shadow);
    display:flex; align-items:center; gap:14px;
  }
  .stat-icon { width:44px; height:44px; border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:20px; flex-shrink:0; }
  .stat-card.total .stat-icon { background:#eff4ff; }
  .stat-card.completed .stat-icon { background:var(--green-bg); }
  .stat-card.pending .stat-icon { background:var(--orange-bg); }
  .stat-card.balance .stat-icon { background:#fdf4ff; }
  .stat-info { flex:1; }
  .stat-label { font-size:11px; font-weight:500; color:var(--muted); margin-bottom:4px; }
  .stat-value { font-size:26px; font-weight:700; line-height:1; letter-spacing:-0.5px; }
  .stat-card.total .stat-value { color:var(--accent); }
  .stat-card.completed .stat-value { color:var(--green); }
  .stat-card.pending .stat-value { color:var(--orange); }
  .stat-card.balance .stat-value { color:#7c3aed; }

  /* FORM */
  .form-panel {
    background:var(--surface); border:1px solid var(--border);
    border-radius:10px; padding:20px 24px; margin-bottom:20px; box-shadow:var(--shadow);
  }
  .form-title {
    font-size:13px; font-weight:600; color:var(--text2); margin-bottom:16px;
    display:flex; align-items:center; gap:8px;
    padding-bottom:12px; border-bottom:1px solid var(--border);
  }
  .form-title::before { content:''; width:3px; height:14px; background:var(--accent); border-radius:2px; }
  .form-grid { display:grid; grid-template-columns:repeat(6,1fr); gap:12px; margin-bottom:12px; }
  .form-grid.row2 { grid-template-columns:repeat(5,1fr) auto auto; }
  .field { display:flex; flex-direction:column; gap:4px; }
  .field label { font-size:11px; font-weight:500; color:var(--text2); }
  .field input, .field select {
    background:var(--surface); border:1px solid var(--border2);
    border-radius:6px; padding:8px 10px; color:var(--text);
    font-family:var(--font); font-size:12.5px; outline:none;
    transition:border-color 0.15s, box-shadow 0.15s; width:100%;
  }
  .field input:focus, .field select:focus { border-color:var(--accent); box-shadow:0 0 0 3px rgba(26,86,219,0.1); }
  .field input::placeholder { color:var(--muted2); }
  .field input[readonly] { background:var(--accent-light); color:var(--accent); font-weight:600; border-color:#c7d7fd; cursor:default; }

  /* BUTTONS */
  .btn {
    padding:8px 18px; border:none; border-radius:6px; font-family:var(--font);
    font-size:12.5px; font-weight:600; cursor:pointer; transition:all 0.15s;
    white-space:nowrap; align-self:flex-end; height:36px;
  }
  .btn-primary { background:var(--accent); color:#fff; }
  .btn-primary:hover { background:var(--accent-hover); transform:translateY(-1px); }
  .btn-ghost { background:var(--surface); color:var(--text2); border:1px solid var(--border2); }
  .btn-ghost:hover { background:var(--surface2); }
  .btn-danger { background:var(--red); color:#fff; border:none; }
  .btn-danger:hover { background:#a90f3f; }

  /* TABLE */
  .table-panel { background:var(--surface); border:1px solid var(--border); border-radius:10px; overflow:hidden; box-shadow:var(--shadow); }
  .table-header {
    display:flex; align-items:center; justify-content:space-between;
    padding:14px 20px; border-bottom:1px solid var(--border);
  }
  .table-header span { font-size:13px; font-weight:600; }
  .search-wrap { position:relative; }
  .search-wrap input {
    background:var(--surface2); border:1px solid var(--border2);
    border-radius:6px; padding:7px 12px 7px 32px; color:var(--text);
    font-family:var(--font); font-size:12px; outline:none; width:220px;
    transition:border-color 0.15s, box-shadow 0.15s;
  }
  .search-wrap input:focus { border-color:var(--accent); box-shadow:0 0 0 3px rgba(26,86,219,0.1); background:var(--surface); }
  .search-wrap input::placeholder { color:var(--muted2); }
  .search-icon { position:absolute; left:10px; top:50%; transform:translateY(-50%); color:var(--muted2); font-size:13px; pointer-events:none; }
  .table-scroll { overflow-x:auto; }
  table { width:100%; border-collapse:collapse; min-width:1100px; }
  thead th {
    background:var(--surface2); padding:9px 12px; font-size:11px;
    text-transform:uppercase; letter-spacing:0.06em; color:var(--muted);
    font-weight:600; text-align:left; border-bottom:1px solid var(--border); white-space:nowrap;
  }
  tbody tr { border-bottom:1px solid var(--border); transition:background 0.1s; }
  tbody tr:last-child { border-bottom:none; }
  tbody tr:nth-child(even) { background:#fafbfc; }
  tbody tr:hover { background:var(--accent-light) !important; }
  tbody td { padding:9px 12px; font-size:12.5px; color:var(--text2); white-space:nowrap; }
  .status-badge { display:inline-flex; align-items:center; padding:2px 10px; border-radius:100px; font-size:11px; font-weight:600; }
  .status-Completed { background:var(--green-bg); color:var(--green); border:1px solid var(--green-border); }
  .status-Pending { background:var(--orange-bg); color:var(--orange); border:1px solid var(--orange-border); }
  .status-Hold { background:var(--red-bg); color:var(--red); border:1px solid var(--red-border); }
  .bq-val { color:#7c3aed; font-weight:600; }
  .oq-val { color:var(--accent); font-weight:500; }
  .order-val { color:var(--text); font-weight:600; }
  .action-btn { padding:4px 10px; border-radius:5px; font-size:11px; font-weight:600; cursor:pointer; border:none; transition:all 0.15s; }
  .btn-edit { background:var(--accent-light); color:var(--accent); border:1px solid #c7d7fd; margin-right:4px; }
  .btn-edit:hover { background:#dbeafe; }
  .btn-delete { background:var(--red-bg); color:var(--red); border:1px solid var(--red-border); }
  .btn-delete:hover { background:#ffe4e6; }
  .empty-state { text-align:center; padding:48px 20px; color:var(--muted); font-size:13px; }
  .empty-state .icon { font-size:32px; margin-bottom:10px; opacity:0.5; }
  .loading-row td { text-align:center; padding:32px; color:var(--muted); font-size:13px; }
  @keyframes spin { to{transform:rotate(360deg);} }
  .spinner { display:inline-block; width:15px; height:15px; border:2px solid var(--border); border-top-color:var(--accent); border-radius:50%; animation:spin 0.7s linear infinite; vertical-align:middle; margin-right:8px; }

  /* AUDIT */
  .audit-panel { background:var(--surface); border:1px solid var(--border); border-radius:10px; overflow:hidden; box-shadow:var(--shadow); }
  .audit-entry { display:flex; align-items:flex-start; gap:14px; padding:14px 20px; border-bottom:1px solid var(--border); transition:background 0.1s; }
  .audit-entry:hover { background:var(--surface2); }
  .audit-entry:last-child { border-bottom:none; }
  .audit-dot { width:34px; height:34px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:14px; flex-shrink:0; margin-top:2px; }
  .audit-add { background:var(--green-bg); }
  .audit-edit { background:var(--accent-light); }
  .audit-delete { background:var(--red-bg); }
  .audit-info { flex:1; }
  .audit-info strong { font-size:13px; font-weight:600; color:var(--text); }
  .audit-info p { font-size:12px; color:var(--muted); margin-top:3px; }
  .audit-time { font-size:11px; color:var(--muted2); white-space:nowrap; padding-top:3px; }

  /* MODAL */
  .modal-overlay { display:none; position:fixed; inset:0; background:rgba(16,24,40,0.5); z-index:100; align-items:center; justify-content:center; }
  .modal-overlay.open { display:flex; }
  .modal { background:var(--surface); border-radius:12px; padding:28px; width:90%; max-width:780px; max-height:90vh; overflow-y:auto; box-shadow:0 20px 60px rgba(16,24,40,0.2); animation:modalIn 0.2s ease; }
  @keyframes modalIn { from{transform:translateY(20px);opacity:0;} to{transform:translateY(0);opacity:1;} }
  .modal-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:20px; padding-bottom:14px; border-bottom:1px solid var(--border); }
  .modal-header h3 { font-size:15px; font-weight:700; }
  .modal-close { width:30px; height:30px; border-radius:6px; border:1px solid var(--border); background:var(--surface2); cursor:pointer; font-size:16px; color:var(--muted); display:flex; align-items:center; justify-content:center; }
  .modal-close:hover { background:var(--red-bg); color:var(--red); border-color:var(--red-border); }
  .modal-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:12px; margin-bottom:12px; }
  .modal-footer { display:flex; justify-content:flex-end; gap:10px; margin-top:20px; padding-top:16px; border-top:1px solid var(--border); }

  .confirm-overlay { display:none; position:fixed; inset:0; background:rgba(16,24,40,0.5); z-index:200; align-items:center; justify-content:center; }
  .confirm-overlay.open { display:flex; }
  .confirm-box { background:var(--surface); border-radius:12px; padding:28px; width:380px; box-shadow:0 20px 60px rgba(16,24,40,0.2); text-align:center; animation:modalIn 0.2s ease; }
  .confirm-icon { font-size:36px; margin-bottom:12px; }
  .confirm-box h4 { font-size:16px; font-weight:700; margin-bottom:8px; }
  .confirm-box p { font-size:13px; color:var(--muted); margin-bottom:20px; }
  .confirm-btns { display:flex; gap:10px; justify-content:center; }

  .toast { position:fixed; bottom:24px; right:24px; background:var(--surface); border:1px solid var(--border); border-left:3px solid #10b981; padding:12px 18px; border-radius:8px; font-size:12.5px; color:var(--text); box-shadow:var(--shadow-md); transform:translateY(80px); opacity:0; transition:all 0.25s cubic-bezier(0.34,1.56,0.64,1); z-index:999; pointer-events:none; }
  .toast.show { transform:translateY(0); opacity:1; }

  @media(max-width:768px) {
    .stats { grid-template-columns:repeat(2,1fr); }
    .form-grid,.form-grid.row2 { grid-template-columns:1fr 1fr; }
    .modal-grid { grid-template-columns:1fr 1fr; }
  }
</style>
</head>
<body>

<!-- LOGIN PAGE -->
<div id="loginPage">
  <div class="login-box">
    <div class="login-logo">
      <div class="icon">üì¶</div>
      <h2>Dispatch Tracker</h2>
      <p>MGT International ‚Äî Sign in to continue</p>
    </div>
    <div class="login-error" id="loginError">‚ùå Invalid username or password</div>
    <div class="login-field">
      <label>Username</label>
      <input type="text" id="loginUser" placeholder="Enter username" onkeydown="if(event.key==='Enter')doLogin()">
    </div>
    <div class="login-field">
      <label>Password</label>
      <input type="password" id="loginPass" placeholder="Enter password" onkeydown="if(event.key==='Enter')doLogin()">
    </div>
    <button class="login-btn" onclick="doLogin()">Sign In ‚Üí</button>
  </div>
</div>

<!-- MAIN APP -->
<div id="mainApp">
  <div class="header">
    <div class="header-left">
      <div class="header-icon">üì¶</div>
      <div>
        <h1>Dispatch Tracker</h1>
        <p>Live Google Sheets Sync ¬∑ MGT International</p>
      </div>
    </div>
    <div class="header-right">
      <div class="live-badge"><div class="live-dot"></div>LIVE</div>
      <div class="user-pill">
        <span id="userLabel">‚Äî</span>
        <span class="role-badge" id="roleLabel">‚Äî</span>
      </div>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
  </div>

  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('dispatch',this)">üìã Dispatch Data</button>
    <button class="tab-btn" onclick="switchTab('audit',this)" id="auditTabBtn">üïµÔ∏è Audit Log</button>
  </div>

  <!-- DISPATCH TAB -->
  <div id="tabDispatch">
    <div class="stats">
      <div class="stat-card total"><div class="stat-icon">üìã</div><div class="stat-info"><div class="stat-label">Total Orders</div><div class="stat-value" id="t1">‚Äî</div></div></div>
      <div class="stat-card completed"><div class="stat-icon">‚úÖ</div><div class="stat-info"><div class="stat-label">Completed</div><div class="stat-value" id="t2">‚Äî</div></div></div>
      <div class="stat-card pending"><div class="stat-icon">‚è≥</div><div class="stat-info"><div class="stat-label">Pending</div><div class="stat-value" id="t3">‚Äî</div></div></div>
      <div class="stat-card balance"><div class="stat-icon">‚öñÔ∏è</div><div class="stat-info"><div class="stat-label">Total Balance</div><div class="stat-value" id="t5">‚Äî</div></div></div>
    </div>

    <div class="form-panel" id="addForm">
      <div class="form-title">Add Dispatch Entry</div>
      <div class="form-grid">
        <div class="field"><label>Date</label><input id="date" type="date"></div>
        <div class="field"><label>Order No *</label><input id="order" placeholder="ORD-001"></div>
        <div class="field"><label>Buyer *</label><input id="buyer" placeholder="Buyer name"></div>
        <div class="field"><label>Item</label><input id="item" placeholder="Item description"></div>
        <div class="field"><label>Order Qty *</label><input id="oq" type="number" placeholder="0"></div>
        <div class="field"><label>Dispatch Qty</label><input id="dq" type="number" placeholder="0"></div>
      </div>
      <div class="form-grid">
        <div class="field"><label>Balance</label><input id="bq" placeholder="Auto" readonly></div>
        <div class="field"><label>Delivery Date 1</label><input id="d1" type="date"></div>
        <div class="field"><label>Delivery Date 2</label><input id="d2" type="date"></div>
        <div class="field"><label>Actual Delivery</label><input id="ad" type="date"></div>
        <div class="field"><label>Status</label><select id="status"><option>Pending</option><option>Completed</option><option>Hold</option></select></div>
        <div class="field"><label>Bill</label><input id="bill" placeholder="Bill no."></div>
      </div>
      <div class="form-grid row2">
        <div class="field"><label>GRN</label><input id="grn" placeholder="GRN no."></div>
        <div class="field"><label>GRN Date</label><input id="grnd" type="date"></div>
        <div class="field" style="grid-column:span 3"><label>Remark</label><input id="remark" placeholder="Optional notes..."></div>
        <button class="btn btn-primary" onclick="add()">+ Add Entry</button>
        <button class="btn btn-ghost" onclick="loadData()">‚Üª Refresh</button>
      </div>
    </div>

    <div class="table-panel">
      <div class="table-header">
        <span>All Dispatches</span>
        <div class="search-wrap">
          <span class="search-icon">‚åï</span>
          <input id="searchInput" placeholder="Search orders..." oninput="filterTable()">
        </div>
      </div>
      <div class="table-scroll">
        <table>
          <thead>
            <tr>
              <th>Date</th><th>Order No</th><th>Buyer</th><th>Item</th>
              <th>OQ</th><th>DQ</th><th>Balance</th>
              <th>Del. Date 1</th><th>Del. Date 2</th><th>Actual Del.</th>
              <th>Status</th><th>Bill</th><th>GRN</th><th>GRN Date</th><th>Remark</th>
              <th id="actionsHeader">Actions</th>
            </tr>
          </thead>
          <tbody id="tb">
            <tr class="loading-row"><td colspan="16"><span class="spinner"></span>Loading data...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- AUDIT TAB -->
  <div id="tabAudit" style="display:none;">
    <div class="audit-panel" id="auditList">
      <div style="padding:32px;text-align:center;color:var(--muted)"><span class="spinner"></span>Loading...</div>
    </div>
  </div>
</div>

<!-- Edit Modal -->
<div class="modal-overlay" id="editModal">
  <div class="modal">
    <div class="modal-header">
      <h3>‚úèÔ∏è Edit Entry</h3>
      <button class="modal-close" onclick="closeEdit()">‚úï</button>
    </div>
    <div class="modal-grid">
      <div class="field"><label>Date</label><input id="e_date" type="date"></div>
      <div class="field"><label>Order No *</label><input id="e_order" placeholder="ORD-001"></div>
      <div class="field"><label>Buyer *</label><input id="e_buyer" placeholder="Buyer name"></div>
      <div class="field"><label>Item</label><input id="e_item" placeholder="Item"></div>
      <div class="field"><label>Order Qty *</label><input id="e_oq" type="number" placeholder="0"></div>
      <div class="field"><label>Dispatch Qty</label><input id="e_dq" type="number" placeholder="0"></div>
      <div class="field"><label>Balance</label><input id="e_bq" readonly></div>
      <div class="field"><label>Delivery Date 1</label><input id="e_d1" type="date"></div>
      <div class="field"><label>Delivery Date 2</label><input id="e_d2" type="date"></div>
      <div class="field"><label>Actual Delivery</label><input id="e_ad" type="date"></div>
      <div class="field"><label>Status</label><select id="e_status"><option>Pending</option><option>Completed</option><option>Hold</option></select></div>
      <div class="field"><label>Bill</label><input id="e_bill" placeholder="Bill no."></div>
      <div class="field"><label>GRN</label><input id="e_grn" placeholder="GRN no."></div>
      <div class="field"><label>GRN Date</label><input id="e_grnd" type="date"></div>
      <div class="field"><label>Remark</label><input id="e_remark" placeholder="Notes..."></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeEdit()">Cancel</button>
      <button class="btn btn-primary" onclick="saveEdit()">üíæ Save Changes</button>
    </div>
  </div>
</div>

<!-- Confirm Delete -->
<div class="confirm-overlay" id="confirmModal">
  <div class="confirm-box">
    <div class="confirm-icon">üóëÔ∏è</div>
    <h4>Delete Entry?</h4>
    <p>Ye entry permanently delete ho jaayegi aur Google Sheet se bhi remove ho jaayegi.</p>
    <div class="confirm-btns">
      <button class="btn btn-ghost" onclick="closeConfirm()">Cancel</button>
      <button class="btn btn-danger" onclick="confirmDelete()">Delete</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const API = "https://script.google.com/macros/s/AKfycbyTuvP-TN00778QcDoXbNHPzc411b4azI1uIrGnonbmRMMOElRS0Ycf9pIhzu5W4Piw4A/exec";
const $ = id => document.getElementById(id);

// ===== USERS =====
const USERS = {
  'Tarun_Thakral':  { pass:'Tarun@MGT',     role:'owner',     name:'Tarun Thakral', display:'Owner' },
  'Vikas_Dispatch': { pass:'Vikash@dis',     role:'hod',       name:'Vikas',         display:'HOD' },
  'Praveen_Pro':    { pass:'Praveen@pro',    role:'hod',       name:'Praveen',       display:'HOD' },
  'Supriya_Sales':  { pass:'Supriya@sales',  role:'hod',       name:'Supriya',       display:'HOD' },
  'Deepak_Cord':    { pass:'Deepak@cord',    role:'hod',       name:'Deepak',        display:'HOD' },
  'Krishan_head':   { pass:'Krishan@head',   role:'planthead', name:'Krishan',       display:'Plant Head' },
};

let currentUser = null;

function doLogin() {
  const u = $('loginUser').value.trim();
  const p = $('loginPass').value;
  if (USERS[u] && USERS[u].pass === p) {
    currentUser = { username: u, ...USERS[u] };
    $('loginError').style.display = 'none';
    $('loginPage').style.display = 'none';
    $('mainApp').style.display = 'block';
    $('userLabel').textContent = currentUser.name;
    $('roleLabel').textContent = currentUser.display;
    $('roleLabel').className = 'role-badge role-' + currentUser.role;
    if (currentUser.role === 'planthead') {
      $('addForm').style.display = 'none';
      $('actionsHeader').style.display = 'none';
      $('auditTabBtn').style.display = 'none';
    }
    loadData();
  } else {
    $('loginError').style.display = 'block';
  }
}

function logout() {
  currentUser = null;
  $('loginPage').style.display = 'flex';
  $('mainApp').style.display = 'none';
  $('loginUser').value = '';
  $('loginPass').value = '';
  // reset tab
  document.querySelectorAll('.tab-btn').forEach((b,i) => { b.classList.toggle('active', i===0); });
  $('tabDispatch').style.display = 'block';
  $('tabAudit').style.display = 'none';
}

// ===== TABS =====
function switchTab(tab, btn) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  $('tabDispatch').style.display = tab === 'dispatch' ? 'block' : 'none';
  $('tabAudit').style.display = tab === 'audit' ? 'block' : 'none';
  if (tab === 'audit') loadAudit();
}

// ===== BALANCE =====
function updateBalance() {
  const oq = parseFloat($('oq').value)||0;
  const dq = parseFloat($('dq').value)||0;
  $('bq').value = oq > 0 ? oq - dq : '';
}
['oq','dq'].forEach(id => {
  $(id).addEventListener('input', updateBalance);
  $(id).addEventListener('change', updateBalance);
});

function updateEditBalance() {
  const oq = parseFloat($('e_oq').value)||0;
  const dq = parseFloat($('e_dq').value)||0;
  $('e_bq').value = oq > 0 ? oq - dq : '';
}
$('e_oq').addEventListener('input', updateEditBalance);
$('e_dq').addEventListener('input', updateEditBalance);

// ===== DATA =====
let data = [], filtered = [], editRowIndex = -1, deleteRowIndex = -1;

function nowStr() {
  return new Date().toLocaleString('en-IN', {
    day:'2-digit', month:'short', year:'numeric',
    hour:'2-digit', minute:'2-digit', hour12:true
  });
}

async function loadData() {
  try {
    const res = await fetch(API);
    const d = await res.json();
    data = d.slice(1).map((r,i) => ({
      _row: i+2,
      date:r[0], order:r[1], buyer:r[2], item:r[3],
      oq:r[4], dq:r[5], bq:r[6],
      d1:r[7], d2:r[8], ad:r[9],
      status:r[10]||'Pending',
      bill:r[11], grn:r[12], grnd:r[13], remark:r[14]
    }));
    filtered = [...data];
    render();
  } catch(e) {
    $('tb').innerHTML = `<tr><td colspan="16" style="text-align:center;padding:32px;color:#c01048;font-size:13px">‚ö† Failed to load. Check connection.</td></tr>`;
  }
}

async function add() {
  if (!$('order').value || !$('buyer').value || !$('oq').value) {
    showToast('‚ö† Order No, Buyer & Order Qty required','error'); return;
  }
  const obj = {
    action:'add',
    date:$('date').value, order:$('order').value,
    buyer:$('buyer').value, item:$('item').value,
    oq:$('oq').value, dq:$('dq').value, bq:$('bq').value,
    d1:$('d1').value, d2:$('d2').value, ad:$('ad').value,
    status:$('status').value, bill:$('bill').value,
    grn:$('grn').value, grnd:$('grnd').value, remark:$('remark').value,
    auditUser:currentUser.name, auditRole:currentUser.display,
    auditTime:nowStr(), auditAction:'Added', auditOrder:$('order').value
  };
  await fetch(API,{method:'POST',body:JSON.stringify(obj)});
  document.querySelectorAll('#addForm input').forEach(i=>i.value='');
  $('status').value='Pending';
  showToast('‚úì Entry added successfully');
  loadData();
}

// EDIT
function openEdit(idx) {
  editRowIndex = idx;
  const d = filtered[idx];
  $('e_date').value=d.date||''; $('e_order').value=d.order||'';
  $('e_buyer').value=d.buyer||''; $('e_item').value=d.item||'';
  $('e_oq').value=d.oq||''; $('e_dq').value=d.dq||''; $('e_bq').value=d.bq||'';
  $('e_d1').value=d.d1||''; $('e_d2').value=d.d2||''; $('e_ad').value=d.ad||'';
  $('e_status').value=d.status||'Pending'; $('e_bill').value=d.bill||'';
  $('e_grn').value=d.grn||''; $('e_grnd').value=d.grnd||''; $('e_remark').value=d.remark||'';
  $('editModal').classList.add('open');
}
function closeEdit() { $('editModal').classList.remove('open'); editRowIndex=-1; }

async function saveEdit() {
  if (!$('e_order').value||!$('e_buyer').value||!$('e_oq').value) {
    showToast('‚ö† Order No, Buyer & Order Qty required','error'); return;
  }
  const d = filtered[editRowIndex];
  const obj = {
    action:'edit', row:d._row,
    date:$('e_date').value, order:$('e_order').value,
    buyer:$('e_buyer').value, item:$('e_item').value,
    oq:$('e_oq').value, dq:$('e_dq').value, bq:$('e_bq').value,
    d1:$('e_d1').value, d2:$('e_d2').value, ad:$('e_ad').value,
    status:$('e_status').value, bill:$('e_bill').value,
    grn:$('e_grn').value, grnd:$('e_grnd').value, remark:$('e_remark').value,
    auditUser:currentUser.name, auditRole:currentUser.display,
    auditTime:nowStr(), auditAction:'Edited', auditOrder:d.order
  };
  await fetch(API,{method:'POST',body:JSON.stringify(obj)});
  closeEdit();
  showToast('‚úì Entry updated');
  loadData();
}
$('editModal').addEventListener('click', e => { if(e.target===$('editModal')) closeEdit(); });

// DELETE
function openDelete(idx) { deleteRowIndex=idx; $('confirmModal').classList.add('open'); }
function closeConfirm() { $('confirmModal').classList.remove('open'); deleteRowIndex=-1; }

async function confirmDelete() {
  const d = filtered[deleteRowIndex];
  await fetch(API,{method:'POST',body:JSON.stringify({
    action:'delete', row:d._row,
    auditUser:currentUser.name, auditRole:currentUser.display,
    auditTime:nowStr(), auditAction:'Deleted', auditOrder:d.order
  })});
  closeConfirm();
  showToast('üóë Entry deleted','error');
  loadData();
}
$('confirmModal').addEventListener('click', e => { if(e.target===$('confirmModal')) closeConfirm(); });

// FILTER & RENDER
function filterTable() {
  const q = $('searchInput').value.toLowerCase();
  filtered = data.filter(d =>
    [d.order,d.buyer,d.item,d.status,d.bill,d.grn,d.remark]
      .some(v=>(v||'').toString().toLowerCase().includes(q))
  );
  render();
}

function render() {
  const canEdit = currentUser && (currentUser.role==='owner'||currentUser.role==='hod');
  const canDelete = currentUser && currentUser.role==='owner';
  if (!filtered.length) {
    $('tb').innerHTML=`<tr><td colspan="16"><div class="empty-state"><div class="icon">üì≠</div>No entries found</div></td></tr>`;
  } else {
    $('tb').innerHTML = filtered.map((d,i)=>`
      <tr>
        <td>${d.date||'‚Äî'}</td>
        <td><strong class="order-val">${d.order}</strong></td>
        <td>${d.buyer}</td>
        <td>${d.item||'‚Äî'}</td>
        <td class="oq-val">${d.oq}</td>
        <td>${d.dq}</td>
        <td class="bq-val">${d.bq}</td>
        <td>${d.d1||'‚Äî'}</td>
        <td>${d.d2||'‚Äî'}</td>
        <td>${d.ad||'‚Äî'}</td>
        <td><span class="status-badge status-${d.status}">${d.status}</span></td>
        <td>${d.bill||'‚Äî'}</td>
        <td>${d.grn||'‚Äî'}</td>
        <td>${d.grnd||'‚Äî'}</td>
        <td style="color:var(--muted)">${d.remark||''}</td>
        <td ${currentUser.role==='planthead'?'style="display:none"':''}>
          ${canEdit?`<button class="action-btn btn-edit" onclick="openEdit(${i})">‚úèÔ∏è Edit</button>`:''}
          ${canDelete?`<button class="action-btn btn-delete" onclick="openDelete(${i})">üóë</button>`:''}
        </td>
      </tr>`).join('');
  }
  $('t1').textContent=data.length;
  $('t2').textContent=data.filter(d=>d.status==='Completed').length;
  $('t3').textContent=data.filter(d=>d.status==='Pending').length;
  $('t5').textContent=data.reduce((a,b)=>a+(+b.bq||0),0);
}

// AUDIT LOG
async function loadAudit() {
  $('auditList').innerHTML=`<div style="padding:32px;text-align:center;color:var(--muted)"><span class="spinner"></span>Loading audit log...</div>`;
  try {
    const res = await fetch(API+'?action=audit');
    const d = await res.json();
    const logs = d.slice(1).filter(r=>r[0]).reverse();
    if (!logs.length) {
      $('auditList').innerHTML=`<div class="empty-state"><div class="icon">üìã</div>No audit records yet</div>`;
      return;
    }
    $('auditList').innerHTML = logs.map(r=>{
      const action=r[0]||'';
      const dc=action==='Added'?'audit-add':action==='Edited'?'audit-edit':'audit-delete';
      const icon=action==='Added'?'‚ûï':action==='Edited'?'‚úèÔ∏è':'üóëÔ∏è';
      return `<div class="audit-entry">
        <div class="audit-dot ${dc}">${icon}</div>
        <div class="audit-info">
          <strong>${r[1]||''} <span style="color:var(--muted);font-weight:400">(${r[2]||''})</span> ‚Äî ${action} Order: <span style="color:var(--accent)">${r[3]||''}</span></strong>
          <p>${r[4]||''}</p>
        </div>
        <div class="audit-time">${r[4]||''}</div>
      </div>`;
    }).join('');
  } catch(e) {
    $('auditList').innerHTML=`<div class="empty-state"><div class="icon">‚ö†Ô∏è</div>Could not load audit log</div>`;
  }
}

function showToast(msg,type='success') {
  const t=$('toast');
  t.textContent=msg;
  t.style.borderLeftColor=type==='error'?'var(--red)':'#10b981';
  t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2800);
}
</script>
</body>
</html>
